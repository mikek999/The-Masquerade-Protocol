<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlayerTXT | Engine Settings</title>
    <link rel="stylesheet" href="styles.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Orbitron:wght@400;700&display=swap"
        rel="stylesheet">
</head>

<body class="admin-body">
    <nav class="admin-nav">
        <ul>
            <li><a href="index.html">DASHBOARD</a></li>
            <li><a href="generator.html">STORY GENERATOR</a></li>
            <li><a href="settings.html" class="active">SETTINGS</a></li>
            <li><a href="/admin/logout" style="color: var(--danger);">LOGOUT</a></li>
        </ul>
    </nav>

    <main class="admin-container">
        <header>
            <h1>System Settings</h1>
            <p>Configure AI Providers and Game Rules.</p>
        </header>

        <section class="generator-section">
            <h2 style="color: var(--text-primary); margin-top: 0;">Operational Controls</h2>

            <div class="stat-card" style="text-align: left; margin-bottom: 2rem;">
                <h3 style="color: var(--text-secondary);">Server Mode</h3>
                <p style="font-size: 0.9rem; margin-bottom: 1rem; color: #888;">Controls player access to the game
                    server.</p>
                <div class="form-group">
                    <select id="server_mode" class="admin-select">
                        <option value="ONLINE">ONLINE (Active)</option>
                        <option value="OFFLINE">OFFLINE (Maintenance)</option>
                    </select>
                </div>
                <button class="btn-primary" id="saveModeBtn"
                    style="font-size: 0.8rem; padding: 0.8rem;">UPDATE_MODE</button>
            </div>

            <h2 style="color: var(--text-primary); margin-top: 2rem;">Security</h2>
            <div class="stat-card" style="text-align: left; margin-bottom: 2rem;">
                <div class="form-group">
                    <label>Change Admin Password</label>
                    <input type="password" id="new_password" placeholder="New Password (min 8 chars)">
                </div>
                <button class="btn-primary" id="changePassBtn"
                    style="font-size: 0.8rem; padding: 0.8rem; background: var(--danger); color: #fff;">UPDATE_PASSWORD</button>
            </div>

            <h2 style="color: var(--text-primary); margin-top: 2rem;">AI Providers</h2>

            <div class="stat-card" style="text-align: left; margin-bottom: 2rem;">
                <div class="form-group">
                    <label>Google Gemini API Key (Director)</label>
                    <input type="password" id="gemini_key" placeholder="AI Studio Key">
                </div>

                <div class="form-group">
                    <label>OpenRouter API Key (Workhorse Cloud)</label>
                    <input type="password" id="openrouter_key" placeholder="sk-or-...">
                </div>

                <div class="form-group">
                    <label>Ollama URL (Workhorse Local)</label>
                    <input type="text" id="ollama_url" value="http://ollama:11434">
                </div>
            </div>

            <div class="stat-card" style="text-align: left;">
                <h3 style="color: var(--text-secondary);">Model Routing</h3>
                <div class="form-group">
                    <label>Workhorse Preference</label>
                    <select id="workhorse_pref" class="admin-select">
                        <option value="ollama">Local (Ollama)</option>
                        <option value="openrouter">Cloud (OpenRouter)</option>
                    </select>
                </div>
            </div>

            <button class="btn-primary" id="saveBtn" style="margin-top: 2rem;">SAVE_CONFIG</button>
            <div id="saveStatus" style="margin-top: 1rem; font-size: 0.8rem;"></div>
        </section>
    </main>

    <script>
        const saveBtn = document.getElementById('saveBtn');
        const status = document.getElementById('saveStatus');

        // Initial Load
        async function loadConfig() {
            try {
                const response = await fetch('/api/v1/admin/config');
                const config = await response.json();

                document.getElementById('gemini_key').value = config.GEMINI_API_KEY || '';
                document.getElementById('openrouter_key').value = config.OPENROUTER_API_KEY || '';
                document.getElementById('ollama_url').value = config.OLLAMA_URL || 'http://ollama:11434';
                document.getElementById('workhorse_pref').value = config.WORKHORSE_PREF || 'ollama';
            } catch (err) {
                console.error("Load failed", err);
            }
        }

        saveBtn.onclick = async () => {
            const data = {
                GEMINI_API_KEY: document.getElementById('gemini_key').value,
                OPENROUTER_API_KEY: document.getElementById('openrouter_key').value,
                OLLAMA_URL: document.getElementById('ollama_url').value,
                WORKHORSE_PREF: document.getElementById('workhorse_pref').value
            };

            status.innerText = "> Syncing with SQL Cluster...";

            try {
                const response = await fetch('/api/v1/admin/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    status.innerText = "> Configuration baked successfully.";
                    status.style.color = "var(--text-accent)";
                } else {
                    status.innerText = "> Error: Sync failed.";
                    status.style.color = "var(--danger)";
                }
            } catch (err) {
                status.innerText = "> Critical: Network error.";
            }
        };

        // Server Mode Logic
        const saveModeBtn = document.getElementById('saveModeBtn');
        const changePassBtn = document.getElementById('changePassBtn');

        async function loadServerMode() {
            try {
                const response = await fetch('/api/v1/admin/server-mode');
                const data = await response.json();
                document.getElementById('server_mode').value = data.mode;
            } catch (err) { console.error(err); }
        }

        saveModeBtn.onclick = async () => {
            const mode = document.getElementById('server_mode').value;
            await fetch('/api/v1/admin/server-mode', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ mode })
            });
            alert('Server Mode Updated');
        };

        changePassBtn.onclick = async () => {
            const newPassword = document.getElementById('new_password').value;
            if (confirm('Are you sure you want to change the Admin Password? You will be logged out.')) {
                const res = await fetch('/api/v1/admin/password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ newPassword })
                });
                if (res.ok) {
                    window.location.href = '/admin/logout';
                } else {
                    alert('Failed to update password');
                }
            }
        };

        loadConfig();
        loadServerMode();
    </script>
    <footer class="admin-footer">
        <div class="footer-content">
            <div class="footer-logo">Made in The Republic of Texas</div>
            <span class="slogan">Your Imagination, Powered by AI.</span>

            <div class="credits">
                Engine Architect: <strong>Mike Kelley</strong><br>
                Core: <strong>Google Gemini</strong> | <strong>Google Antigravity</strong> | <strong>SQL Server
                    2025</strong>
            </div>
            <div class="links">
                <a href="https://playertxt.org" target="_blank">Official Project Website</a>
            </div>
            <div class="copyright">
                &copy; 2026 PlayerTXT Protocol. Open Source License. Portions &copy; 1980 Retro-Vibe.
            </div>
        </div>
    </footer>

</html>