<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlayerTXT | Game Engine</title>
    <link rel="stylesheet" href="styles.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Orbitron:wght@400;700&display=swap"
        rel="stylesheet">
</head>

<body class="admin-body">
    <header class="global-header">
        <h1>PlayerTXT Game Engine</h1>
        <div class="header-slogan">Your Imagination, Powered by AI.</div>
    </header>

    <nav class="admin-nav">
        <ul>
            <li><a href="index.html" class="active">DASHBOARD</a></li>
            <li><a href="generator.html">STORY GENERATOR</a></li>
            <li><a href="settings.html">SETTINGS</a></li>
            <li><a href="/admin/logout" style="color: var(--danger);">LOGOUT</a></li>
        </ul>
    </nav>

    <main class="admin-container">
        <header class="page-header-flex">
            <div class="page-title">
                <h2>Dashboard</h2>
                <span class="version-badge"
                    style="background: rgba(255,255,255,0.1); color: #888; margin: 0; padding: 0.1rem 0.5rem;">Version
                    1.0.0</span>
            </div>

            <div class="status-container">
                <div style="display: flex; align-items: center; gap: 1rem; justify-content: flex-end;">
                    <p style="margin: 0; font-size: 0.9rem;">Status: <span id="sysStatus"
                            class="status-active">CHECKING...</span></p>
                </div>
                <div id="serverIp" class="server-ip"></div>
            </div>
        </header>

        <section class="admin-stats">
            <h3>Active Players</h3>
            <div class="value">0</div>
            </div>

            <div class="stat-card" style="min-width: 250px;">
                <h3>AI Systems</h3>
                <div style="font-size: 0.8rem; text-align: left; margin-top: 0.5rem;">
                    <div style="margin-bottom: 5px;">
                        <span style="color: #888;">DIRECTOR:</span> <span id="dashDirectorStatus">--</span>
                        <div style="font-size: 0.7rem; color: #555;" id="dashDirectorModel">...</div>
                    </div>
                    <div>
                        <span style="color: #888;">WORKHORSE:</span> <span id="dashWorkhorseStatus">--</span>
                        <div style="font-size: 0.7rem; color: #555;" id="dashWorkhorseModel">...</div>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-card">
                    <h3>Mission Timer</h3>
                    <div class="value" id="dashTimer">--:--</div>
                </div>
                <div class="stat-card">
                    <h3>Global State</h3>
                    <div class="value" id="dashStatus">IDLE</div>
                </div>
        </section>

        <!-- Mission Control Panel -->
        <section class="admin-table-container" style="border-left: 4px solid var(--accent-color);">
            <h2>Mission Control</h2>
            <div style="display: flex; gap: 2rem; align-items: flex-end;">
                <div class="form-group" style="flex: 1; margin-bottom: 0;">
                    <label>Select Operation (Story)</label>
                    <select id="storySelect" class="admin-select">
                        <option value="">LOADING STORIES...</option>
                    </select>
                </div>
                <div class="form-group" style="width: 150px; margin-bottom: 0;">
                    <label>Duration (Min)</label>
                    <input type="number" id="gameDuration" value="30" min="5" max="180">
                </div>
                <button id="startMissionBtn" class="btn-primary" style="height: 50px;">INITIATE LAUNCH</button>
            </div>
        </section>

        <section class="admin-table-container">
            <h2>Active Players</h2>
            <table class="admin-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Character</th>
                        <th>Room</th>
                        <th>Type</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="playerTableBody">
                    <!-- Data will be populated here -->
                    <tr>
                        <td colspan="6" class="no-data">No active players found.</td>
                    </tr>
                </tbody>
            </table>
        </section>

        <!-- Log Viewer Section -->
        <section class="admin-logs-container">
            <h2>System Logs</h2>
            <div id="logWindow" class="log-window">
                <div class="log-entry">Connecting to protocol stream...</div>
            </div>
        </section>
    </main>

    <footer class="admin-footer">
        <div class="footer-content">
            <div class="footer-logo">Made in The Republic of Texas</div>

            <div class="credits">
                Engine Architect: <strong>Mike Kelley</strong><br>
                Core: <strong>Google Gemini</strong> | <strong>Google Antigravity</strong> | <strong>SQL Server
                    2025</strong>
            </div>
            <div class="links">
                <a href="https://playertxt.org" target="_blank">Official Project Website</a>
            </div>
            <div class="copyright">
                &copy; 2026 PlayerTXT Protocol. Open Source License. Portions &copy; 1980 Retro-Vibe.
            </div>
        </div>
    </footer>

    <script>
        async function updateStatus() {
            try {
                const res = await fetch('/api/v1/admin/status');
                const data = await res.json();

                const statusSpan = document.getElementById('sysStatus');

                if (data.dbStatus === 'ONLINE') {
                    statusSpan.innerText = 'ONLINE';
                    statusSpan.style.color = '#00ff9d';
                } else {
                    statusSpan.innerText = 'DB DISCONNECTED';
                    statusSpan.style.color = '#ff4d4d';
                }

                document.getElementById('serverIp').innerText = data.ip;

                // AI Status
                if (data.aiStatus) {
                    const d = data.aiStatus.director;
                    const w = data.aiStatus.workhorse;

                    const dEl = document.getElementById('dashDirectorStatus');
                    dEl.innerText = d.status;
                    dEl.className = d.status === 'ONLINE' ? 'status-active' : 'status-offline'; // reusing css
                    dEl.style.color = d.status === 'ONLINE' ? '#00ff9d' : '#ff4d4d';
                    document.getElementById('dashDirectorModel').innerText = d.model;

                    const wEl = document.getElementById('dashWorkhorseStatus');
                    wEl.innerText = w.status;
                    wEl.style.color = w.status === 'ONLINE' ? '#00ff9d' : '#ff4d4d';
                    document.getElementById('dashWorkhorseModel').innerText = w.model;
                }


                // --- Mission Control Logic ---
                loadStories();
                updateMissionStatus();
                setInterval(updateMissionStatus, 1000);

                const missionBtn = document.getElementById('startMissionBtn');

                missionBtn.onclick = async () => {
                    const status = document.getElementById('dashStatus').innerText;

                    if (status === 'RUNNING' || status === 'WAITING') {
                        // ABORT ACTION
                        if (!confirm('ABORT MISSION? This will disconnect all players.')) return;

                        await fetch('/api/v1/admin/game/stop', { method: 'POST' });
                        alert('Mission Aborted.');
                    } else {
                        // START ACTION
                        const worldId = document.getElementById('storySelect').value;
                        const duration = document.getElementById('gameDuration').value;
                        if (!worldId) return alert('Select a Story first');

                        const res = await fetch('/api/v1/admin/game/schedule', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ worldId, durationMinutes: duration })
                        });

                        if (res.ok) {
                            alert('Mission Sequence Initiated');
                        } else {
                            const err = await res.json();
                            alert('Launch Failed: ' + err.error);
                        }
                    }
                    updateMissionStatus();
                };

            } catch (e) {
                document.getElementById('sysStatus').innerText = 'OFFLINE';
            }
        }

        async function loadStories() {
            try {
                const res = await fetch('/api/v1/admin/stories');
                const stories = await res.json();
                const sel = document.getElementById('storySelect');
                sel.innerHTML = '<option value="">-- SELECT TARGET --</option>';
                stories.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s.WorldID;
                    opt.innerText = s.Name;
                    sel.appendChild(opt);
                });
            } catch (e) { console.error('Load stories failed', e); }
        }

        async function updateMissionStatus() {
            try {
                const res = await fetch('/api/v1/admin/game/status');
                const data = await res.json();

                const statusEl = document.getElementById('dashStatus');
                statusEl.innerText = data.status;

                const btn = document.getElementById('startMissionBtn');

                // Pre-flight check viz
                const sysStatus = document.getElementById('sysStatus');
                if (data.checks && (!data.checks.sql || !data.checks.llm)) {
                    sysStatus.innerText = 'FAULT';
                    sysStatus.className = 'status-offline';
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    btn.innerText = 'SYSTEM FAULT';
                } else {
                    sysStatus.innerText = 'ONLINE';
                    sysStatus.className = 'status-active';
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }

                // Toggle Button State
                if (data.status === 'RUNNING' || data.status === 'WAITING') {
                    btn.innerText = 'ABORT MISSION';
                    btn.style.background = 'red';
                    btn.style.color = 'white';
                } else if (!btn.disabled) {
                    btn.innerText = 'INITIATE LAUNCH';
                    btn.style.background = ''; // reset to default CSS
                    btn.style.color = '';
                }

                // Format Timer
                if (data.timer > 0) {
                    const m = Math.floor(data.timer / 60);
                    const s = data.timer % 60;
                    document.getElementById('dashTimer').innerText = `${m}:${s < 10 ? '0' + s : s}`;
                } else {
                    document.getElementById('dashTimer').innerText = '--:--';
                }
            } catch (e) { }
        }

        // Initial Load
        updateStatus();
        setInterval(updateStatus, 10000);

        // Existing Dashboard Logic
        async function updateStats() {
            try {
                const response = await fetch('/api/v1/admin/stats');
                const stats = await response.json();

                document.querySelectorAll('.stat-card .value')[0].innerText = stats.activeSessions;
                document.querySelectorAll('.stat-card .value')[1].innerText = stats.onlinePlayers;
                document.querySelectorAll('.stat-card .value')[2].innerText = stats.aiAgents;
            } catch (err) {
                console.error("Failed to fetch stats", err);
            }
        }

        async function updatePlayers() {
            try {
                const response = await fetch('/api/v1/admin/players');
                const players = await response.json();
                const tbody = document.getElementById('playerTableBody');

                if (players.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="no-data">No active players found.</td></tr>';
                    return;
                }

                tbody.innerHTML = players.map(p => `
                    <tr>
                        <td>${p.PlayerID}</td>
                        <td>${p.Username}</td>
                        <td>${p.CharacterName || 'N/A'}</td>
                        <td>${p.RoomName || 'Lobby'}</td>
                        <td>${p.IsAI ? 'AI' : 'HUMAN'}</td>
                        <td><span class="status-active">ACTIVE</span></td>
                    </tr>
                `).join('');
            } catch (err) {
                console.error("Failed to fetch players", err);
            }
        }

        async function updateLogs() {
            try {
                const response = await fetch('/api/v1/admin/logs');
                const logs = await response.json();
                const logWindow = document.getElementById('logWindow');

                logWindow.innerHTML = logs.map(l => `
                    <div class="log-entry">
                        <span class="timestamp">[${new Date(l.timestamp).toLocaleTimeString()}]</span>
                        <span class="level level-${l.level}">${l.level}</span>
                        <span class="message">${l.message}</span>
                    </div>
                `).join('');

                // Auto-scroll to bottom
                logWindow.scrollTop = logWindow.scrollHeight;
            } catch (err) {
                console.error("Failed to fetch logs", err);
            }
        }

        // Refresh cycles
        setInterval(updateStats, 5000);
        setInterval(updatePlayers, 5000);
        setInterval(updateLogs, 3000);
        updateStats();
        updatePlayers();
        updateLogs();
    </script>
</body>

</html>